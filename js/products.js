(()=>{const $=(s,c=document)=>c.querySelector(s);const UI={tipo:$('#f-tipo'),marca:$('#f-marca'),modelo:$('#f-modelo'),anio:$('#f-anio'),q:$('#f-q'),apply:$('#f-apply'),clear:$('#f-clear'),results:$('#results'),info:$('#info'),toggleAll:$('#toggleAll'),specModal:$('#specModal'),specBody:$('#specBody'),specTitle:$('#specTitle'),cartBtn:$('#miniCart'),cartCount:$('#cartCount')};let ALL=[],LIST=[],showingAll=false,cart=0;const dedup=a=>[...new Set(a)].filter(Boolean).sort((x,y)=>(''+x).localeCompare(''+y,'es',{numeric:true}));function norm(raw){const sku=(raw.sku||'').toUpperCase();const name=raw.name||'Batería';const brand=raw.brand||'';const model=raw.model||'';const year=raw.year||'';const cats=(raw.cats||[]).map(c=>(''+c).toLowerCase());let tipo='BATERÍAS';for(const c of ['batería óptima','batería optima','moto-batería','equipo pesado','ciclado profundo','acumuladores']){if(cats.includes(c)){tipo=c.replace(/\b\w/g,s=>s.toUpperCase());break;}}return {sku,nombre:name,marca:brand,modelo:model,anio:year,tipo,imagen:'assets/hero3.jpg',specs:{Marca:brand||'—',Modelo:model||'—',Año:year||'—',Tipo:tipo}};}function seed(){const tipos=dedup(LIST.map(p=>p.tipo));UI.tipo.innerHTML='<option value="">Todos</option>'+tipos.map(x=>`<option>${x}</option>`).join('');const marcas=dedup(LIST.map(p=>p.marca));UI.marca.innerHTML='<option value="">Todas</option>'+marcas.map(x=>`<option>${x}</option>`).join('');const modelos=dedup(LIST.map(p=>p.modelo));UI.modelo.innerHTML='<option value="">Todos</option>'+modelos.map(x=>`<option>${x}</option>`).join('');const anios=dedup(LIST.map(p=>p.anio));UI.anio.innerHTML='<option value="">Todos</option>'+anios.map(x=>`<option>${x}</option>`).join('');}function apply(){let list=[...ALL];const t=(UI.tipo.value||'').toLowerCase(),m=(UI.marca.value||'').toLowerCase(),mo=(UI.modelo.value||'').toLowerCase(),a=(UI.anio.value||'').toLowerCase(),q=(UI.q.value||'').toLowerCase();if(t) list=list.filter(p=>(p.tipo||'').toLowerCase()===t);if(m) list=list.filter(p=>(p.marca||'').toLowerCase()===m);if(mo) list=list.filter(p=>(p.modelo||'').toLowerCase()===mo);if(a) list=list.filter(p=>(p.anio||'').toLowerCase()===a);if(q) list=list.filter(p=>(p.nombre+' '+(p.sku||'')).toLowerCase().includes(q));LIST=list;showingAll=false;render();}function setInfo(shown,total){UI.info.textContent=`Mostrando ${shown} de ${total} productos registrados`;}function render(){UI.results.innerHTML='';const shown=showingAll?LIST:LIST.slice(0,5);setInfo(shown.length,LIST.length);shown.forEach(p=>UI.results.appendChild(card(p)));UI.toggleAll.style.display=LIST.length>5?'inline-flex':'none';UI.toggleAll.textContent=showingAll?'Mostrar menos':'Ver todo';}function card(p){const el=document.createElement('article');el.className='product-card';el.innerHTML=`<img src="${p.imagen}" alt="Imagen de ${p.nombre}"/><div><h3 class="title">${p.nombre} ${p.sku?`<small>(${p.sku})</small>`:''}</h3><p class="meta">${[p.marca,p.modelo,p.anio].filter(Boolean).join(' · ')}</p><div class="kv"><span class="tag">${p.tipo}</span></div></div><div class="actions"><button class="btn" data-spec="${p.sku}">Ver especificaciones</button><a class="btn primary" data-wa="${p.sku}">Pedir por WhatsApp</a></div>`;el.querySelector('[data-spec]').addEventListener('click',()=>openSpecs(p));el.querySelector('[data-wa]').addEventListener('click',(e)=>{e.preventDefault();cart++;UI.cartCount.textContent=String(cart);const msg=`Hola Battery Boss 👋 quiero esta batería:\n• Producto: ${p.nombre}\n• SKU: ${p.sku}\n• Marca: ${p.marca}\n• Modelo: ${p.modelo}\n• Año: ${p.anio}\n• Tipo: ${p.tipo}`;window.open(`https://wa.me/522225773967?text=${encodeURIComponent(msg)}`,'_blank');});return el;}function openSpecs(p){UI.specTitle.textContent=`${p.nombre}${p.sku?` (${p.sku})`:''}`;const rows=Object.entries(p.specs||{}).map(([k,v])=>`<tr><th>${k}</th><td>${v||'—'}</td></tr>`).join('');UI.specBody.innerHTML=`<div class='spec'><img src='${p.imagen}' alt='' style='width:120px;height:120px;border-radius:12px;border:1px solid rgba(2,6,23,.08)'/><table class='spec-table'>${rows}</table></div>`;UI.specModal.setAttribute('aria-hidden','false');}document.addEventListener('click',(e)=>{if(e.target.matches('[data-close]')||e.target.classList.contains('modal-bg')) UI.specModal.setAttribute('aria-hidden','true');});UI.apply.addEventListener('click',apply);UI.clear.addEventListener('click',()=>{UI.tipo.value=UI.marca.value=UI.modelo.value=UI.anio.value='';UI.q.value='';LIST=[...ALL];showingAll=false;seed();render();});UI.toggleAll.addEventListener('click',()=>{showingAll=!showingAll;render();});fetch('data/products-bb-all.json').then(r=>r.json()).then(arr=>{ALL=(Array.isArray(arr)?arr:[]).map(norm);LIST=[...ALL];seed();render();});})();